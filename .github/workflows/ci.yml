name: CI

on:
  push:
  pull_request:

jobs:
  build-and-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install C++17 compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y g++

      - name: Build release binary
        run: |
          g++ -std=c++17 -Wall -Wextra -Wpedantic -pthread \
            src/adaptive_iv_therapy_control_system.cpp \
            src/SystemLogger.cpp \
            src/SafetyMonitor.cpp \
            src/StateEstimator.cpp \
            src/AdaptiveController.cpp \
            -o ai_iv

      - name: Build alert smoke-test variant
        run: |
          g++ -std=c++17 -Wall -Wextra -Wpedantic -pthread -DAI_IV_ALERT_LOG_TEST \
            src/adaptive_iv_therapy_control_system.cpp \
            src/SystemLogger.cpp \
            src/SafetyMonitor.cpp \
            src/StateEstimator.cpp \
            src/AdaptiveController.cpp \
            -o ai_iv_alert_test

      - name: Run alert smoke-test
        run: ./ai_iv_alert_test

      - name: Build with REST API support
        run: |
          g++ -std=c++17 -Wall -Wextra -Wpedantic -pthread -DENABLE_REST_API \
            src/adaptive_iv_therapy_control_system.cpp \
            src/rest_api_server.cpp \
            src/SystemLogger.cpp \
            src/SafetyMonitor.cpp \
            src/StateEstimator.cpp \
            src/AdaptiveController.cpp \
            -o ai_iv_with_api

      - name: Verify REST API binary
        run: |
          test -f ai_iv_with_api
          echo "REST API build successful"

      - name: Build and run unit tests
        run: |
          g++ -std=c++17 -Wall -Wextra -pthread -I src \
            tests/test_safety_monitor.cpp \
            src/SystemLogger.cpp \
            src/SafetyMonitor.cpp \
            src/StateEstimator.cpp \
            src/AdaptiveController.cpp \
            -o test_safety_monitor
          g++ -std=c++17 -Wall -Wextra -pthread -I src \
            tests/test_state_estimator.cpp \
            src/SystemLogger.cpp \
            src/SafetyMonitor.cpp \
            src/StateEstimator.cpp \
            src/AdaptiveController.cpp \
            -o test_state_estimator
          ./test_safety_monitor
          ./test_state_estimator
