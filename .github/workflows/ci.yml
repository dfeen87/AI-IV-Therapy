name: CI

on:
  push:
  pull_request:

jobs:
  build-and-smoke:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install C++17 compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y g++

      - name: Build release binary
        run: |
          g++ -std=c++17 -Wall -Wextra -Wpedantic -pthread \
            src/adaptive_iv_therapy_control_system.cpp \
            src/SystemLogger.cpp \
            src/SafetyMonitor.cpp \
            src/StateEstimator.cpp \
            src/AdaptiveController.cpp \
            -o ai_iv

      - name: Build alert smoke-test variant
        run: |
          g++ -std=c++17 -Wall -Wextra -Wpedantic -pthread -DAI_IV_ALERT_LOG_TEST \
            src/adaptive_iv_therapy_control_system.cpp \
            src/SystemLogger.cpp \
            src/SafetyMonitor.cpp \
            src/StateEstimator.cpp \
            src/AdaptiveController.cpp \
            -o ai_iv_alert_test

      - name: Run alert smoke-test
        run: ./ai_iv_alert_test

      - name: Build with REST API support
        run: |
          g++ -std=c++17 -Wall -Wextra -Wpedantic -pthread -DENABLE_REST_API \
            src/adaptive_iv_therapy_control_system.cpp \
            src/rest_api_server.cpp \
            src/SystemLogger.cpp \
            src/SafetyMonitor.cpp \
            src/StateEstimator.cpp \
            src/AdaptiveController.cpp \
            -o ai_iv_with_api

      - name: Verify REST API binary
        run: |
          test -f ai_iv_with_api
          echo "REST API build successful"

      - name: Build and run unit tests
        run: |
          g++ -std=c++17 -Wall -Wextra -pthread -I src \
            tests/test_safety_monitor.cpp \
            src/SystemLogger.cpp \
            src/SafetyMonitor.cpp \
            src/StateEstimator.cpp \
            src/AdaptiveController.cpp \
            -o test_safety_monitor
          g++ -std=c++17 -Wall -Wextra -pthread -I src \
            tests/test_state_estimator.cpp \
            src/SystemLogger.cpp \
            src/SafetyMonitor.cpp \
            src/StateEstimator.cpp \
            src/AdaptiveController.cpp \
            -o test_state_estimator
          ./test_safety_monitor
          ./test_state_estimator

  neural-estimator:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y g++ libeigen3-dev libfdeep-dev \
                                  libfplus-dev nlohmann-json3-dev

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-tf-${{ hashFiles('tools/train_sensor_fusion_model.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-tf-

      - name: Install Python ML dependencies
        run: pip3 install --quiet tensorflow numpy

      - name: Train and export sensor fusion model
        run: python3 tools/train_sensor_fusion_model.py --out-dir models

      - name: Build neural-estimator variant
        run: |
          g++ -std=c++17 -Wall -Wextra -pthread -O2 \
            -I src -I/usr/include/eigen3 \
            -DENABLE_NEURAL_ESTIMATOR \
            -DNEURAL_MODEL_PATH='"models/sensor_fusion_fdeep.json"' \
            src/adaptive_iv_therapy_control_system.cpp \
            src/SystemLogger.cpp \
            src/SafetyMonitor.cpp \
            src/StateEstimator.cpp \
            src/AdaptiveController.cpp \
            -o ai_iv_neural

      - name: Build and run neural estimator unit tests
        run: |
          g++ -std=c++17 -Wall -Wextra -pthread -O2 \
            -I src -I/usr/include/eigen3 \
            -DENABLE_NEURAL_ESTIMATOR \
            -DNEURAL_MODEL_PATH='"models/sensor_fusion_fdeep.json"' \
            tests/test_neural_estimator.cpp \
            src/SystemLogger.cpp \
            src/SafetyMonitor.cpp \
            src/StateEstimator.cpp \
            src/AdaptiveController.cpp \
            -o test_neural_estimator
          ./test_neural_estimator

